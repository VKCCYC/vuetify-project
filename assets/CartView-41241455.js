import{Y as S,Z as A,X as D,x as y,o as x,A as N,a0 as k,a2 as $,a3 as c,ab as R,c as a,a1 as C,aa as i,J as d,a8 as b,an as g}from"./index-fa4fcbb1.js";import{V as T}from"./VContainer-87a07670.js";import{V as _,a as E}from"./VRow-200d9de1.js";import{V as I}from"./VDivider-c328c9e5.js";import{V as J}from"./VDataTable-04c1ead2.js";import"./VList-cbe5b826.js";const L=g("h1",null,"購物車",-1),M={key:0},U={key:1,class:"text-red text-decoration-line-through"},H={__name:"CartView",setup(X){const{apiAuth:p}=R(),l=S(),m=A(),f=D(),s=y([]),V=[{title:"商品名稱",key:"product.name"},{title:"單價",key:"product.price"},{title:"數量",key:"quantity"},{title:"總價",key:"total",value:e=>e.product.price*e.quantity},{title:"操作",key:"action"}],w=x(()=>s.value.reduce((e,o)=>e+o.quantity*o.product.price,0)),B=x(()=>s.value.length>0&&!s.value.some(e=>!e.product.sell)),h=async(e,o)=>{var t,n;if(!m.isLogin){f.push("/login");return}try{const{data:r}=await p.patch("/users/cart",{product:e,quantity:o});m.cart=r.result,l({text:"修改成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}});const u=s.value.findIndex(P=>P.product._id===e);s.value[u].quantity+=o,s.value[u].quantity<=0&&s.value.splice(u,1)}catch(r){const u=((n=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:n.message)||"發生錯誤，請稍後再試";l({text:u,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},v=y(!1),q=async()=>{var e,o;v.value=!0;try{await p.post("/orders"),m.cart=0,f.push("/orders"),l({text:"結帳成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(t){console.log(t);const n=((o=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";l({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}v.value=!1};return N(async()=>{var e,o;try{const{data:t}=await p.get("/users/cart");s.value.push(...t.result)}catch(t){console.log(t);const n=((o=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";l({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),(e,o)=>(k(),$(T,null,{default:c(()=>[a(E,null,{default:c(()=>[a(_,{cols:"12"},{default:c(()=>[L]),_:1}),a(I),a(_,{cols:"12"},{default:c(()=>[a(J,{items:s.value,headers:V},{"item.product.name":c(({item:t})=>[t.product.sell?(k(),C("span",M,i(t.product.name),1)):(k(),C("span",U,i(t.product.name)+" (已下架)",1))]),"item.quantity":c(({item:t})=>[a(d,{variant:"text",icon:"mdi-minus",color:"red",onClick:n=>h(t.product._id,-1)},null,8,["onClick"]),b(i(t.quantity),1),a(d,{variant:"text",icon:"mdi-plus",color:"green",onClick:n=>h(t.product._id,1)},null,8,["onClick"])]),"item.action":c(({item:t})=>[a(d,{variant:"text",icon:"mdi-delete",color:"red",onClick:n=>h(t.product._id,t.quantity*-1)},null,8,["onClick"])]),_:2},1032,["items"])]),_:1}),a(_,{class:"text-center",cols:"12"},{default:c(()=>[g("p",null,"總金額: "+i(w.value),1),a(d,{color:"pink",disabled:!B.value,onClick:q},{default:c(()=>[b("結帳")]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1}))}};export{H as default};
